<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixi.js with WebSocket</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            user-select: none; /* ì „ì²´ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            -webkit-user-select: none; /* ì›¹í‚· ë¸Œë¼ìš°ì € ì§€ì› */
            -ms-user-select: none; /* êµ¬í˜• IE ì§€ì› */
        }

        canvas {
            display: block;
            user-select: none; /* ì „ì²´ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            -webkit-user-select: none; /* ì›¹í‚· ë¸Œë¼ìš°ì € ì§€ì› */
            -ms-user-select: none; /* êµ¬í˜• IE ì§€ì› */
        }

        /* ë°©í–¥í‚¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .row {
            display: flex;
            gap: 5px;
        }

        .arrow-btn {
            width: 48px;
            height: 48px;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            -webkit-user-select: none; /* ì›¹í‚· ë¸Œë¼ìš°ì € ì§€ì› */
            -ms-user-select: none; /* êµ¬í˜• IE ì§€ì› */
        }

        .arrow-btn:hover {
            background-color: #555;
        }

        .send-btn {
            display: flex;
            background-color: #333;
            color: #ffffff;
            width: 50px;
            height: 36px;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 4px;
            user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            -webkit-user-select: none; /* ì›¹í‚· ë¸Œë¼ìš°ì € ì§€ì› */
            -ms-user-select: none; /* êµ¬í˜• IE ì§€ì› */
        }

        #chat-input {
            height: 36px;
            width: 160px;
            padding-left: 8px;
            border-radius: 4px;
            font-size: 16px; /* í™”ë©´ í™•ëŒ€ ë°©ì§€ */
            user-select: text; /* ì…ë ¥ í•„ë“œëŠ” í…ìŠ¤íŠ¸ ì„ íƒ í—ˆìš© */
        }

        #chat-input:focus {
            outline: none;
        }

        #chat-container {
            column-gap: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 300px;
            text-align: center;
        }

        .emoji-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            text-align: center;
            width: 48px;
            height: 48px;
            cursor: pointer;
            background: #333;
            border-radius: 4px;
            user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */

            -webkit-user-select: none; /* ì›¹í‚· ë¸Œë¼ìš°ì € ì§€ì› */
            -ms-user-select: none; /* êµ¬í˜• IE ì§€ì› */
        }

        #emoji-container {
            row-gap: 4px;
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #countdown {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 700;
            font-size: 72px;
            color: white;
            z-index: 1000;
        }

        #score_results {
            background-color: #575757b2;
            padding: 20px;
            width: 80vw;
            height: 50vh;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 14px;
            color: white;
            z-index: 1000;
            text-align: center;
        }
    </style>
</head>
<body>
<div id="countdown" style="display: none;"></div>

<div id="score_results" style="display: none">
</div>

<!-- ë°©í–¥í‚¤ ë²„íŠ¼ UI -->
<div class="controls">
    <button class="arrow-btn" id="upButton"
            onmousedown="simulateKeyEvent('ArrowUp', 'keydown')"
            onmouseup="simulateKeyEvent('ArrowUp', 'keyup')"
            ontouchstart="simulateKeyEvent('ArrowUp', 'keydown')"
            ontouchend="simulateKeyEvent('ArrowUp', 'keyup')">
        â†‘
    </button>
    <div class="row">
        <button class="arrow-btn" id="leftButton"
                onmousedown="simulateKeyEvent('ArrowLeft', 'keydown')"
                onmouseup="simulateKeyEvent('ArrowLeft', 'keyup')"
                ontouchstart="simulateKeyEvent('ArrowLeft', 'keydown')"
                ontouchend="simulateKeyEvent('ArrowLeft', 'keyup')">
            â†
        </button>
        <button class="arrow-btn" id="downButton"
                onmousedown="simulateKeyEvent('ArrowDown', 'keydown')"
                onmouseup="simulateKeyEvent('ArrowDown', 'keyup')"
                ontouchstart="simulateKeyEvent('ArrowDown', 'keydown')"
                ontouchend="simulateKeyEvent('ArrowDown', 'keyup')">
            â†“
        </button>
        <button class="arrow-btn" id="rightButton"
                onmousedown="simulateKeyEvent('ArrowRight', 'keydown')"
                onmouseup="simulateKeyEvent('ArrowRight', 'keyup')"
                ontouchstart="simulateKeyEvent('ArrowRight', 'keydown')"
                ontouchend="simulateKeyEvent('ArrowRight', 'keyup')">
            â†’
        </button>
    </div>

    <div id="chat-container" style="display: none">
        <input id="chat-input" type="text" placeholder="Type your message..."/>
        <div class="send-btn" onclick="sendChat()">Send</div>
    </div>
</div>
<div id="emoji-container">
    <div class="emoji-btn" onclick="toggleChatForm()">ğŸ’¬</div>
    <div class="emoji-btn" onclick="sendEmoji('ğŸ˜€')">ğŸ˜€</div>
    <div class="emoji-btn" onclick="sendEmoji('ğŸ‘')">ğŸ‘</div>
    <div class="emoji-btn" onclick="sendEmoji('ğŸ‰')">ğŸ‰</div>
    <div class="emoji-btn" onclick="sendEmoji('â¤ï¸')">â¤ï¸</div>
</div>

<script>
    function toggleChatForm() {
        const chatContainer = document.getElementById("chat-container");
        chatContainer.style.display = chatContainer.style.display === "none" ? "" : "none";
        chatInput.focus(); // ì…ë ¥ì°½ì— ìë™ í¬ì»¤ìŠ¤
    }

    // Pixi.js Application
    const app = new PIXI.Application({
        width: window.innerWidth,
        height: window.innerHeight,
        backgroundColor: 0x2c3e50,
        antialias: true, // ì•ˆí‹°ì•Œë¦¬ì•„ìŠ¤ í™œì„±í™”
    });

    // UI ë ˆì´ì–´ ìƒì„± (í™”ë©´ ê³ ì •ìš©)
    const uiLayer = new PIXI.Container();
    app.stage.addChild(uiLayer);

    document.body.appendChild(app.view);

    // ì‚¬ìš©ì ìƒíƒœ ê´€ë¦¬
    const users = {};
    let userId = '{{ username }}';
    let lastSentPosition = {x: 0, y: 0}; // ë§ˆì§€ë§‰ìœ¼ë¡œ ì„œë²„ì— ì „ì†¡ëœ ìœ„ì¹˜
    let cameraPosition = {x: 0, y: 0}; // ì¹´ë©”ë¼ì˜ í˜„ì¬ ìœ„ì¹˜

    const cellSize = 50; // ê·¸ë¦¬ë“œ ì…€ í¬ê¸°
    const gridOffsetX = app.screen.width / 2; // í™”ë©´ ì¤‘ì•™ X ì˜¤í”„ì…‹
    const gridOffsetY = app.screen.height / 2; // í™”ë©´ ì¤‘ì•™ Y ì˜¤í”„ì…‹

    // ê¸°ë³¸ ì¤Œ ë° ë“œë˜ê·¸ ë³€ìˆ˜
    let zoomLevel = 0.5;

    // í‚¤ ì…ë ¥ ìƒíƒœ
    const keys = {ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false};
    let baseSpeed = 5;

    const VOTING_ZONES = [
        {id: 1, x: -6, y: -11, width: 8, height: 8, color: 0xff9999},
        {id: 2, x: 6, y: -11, width: 8, height: 8, color: 0x99ff99},
        {id: 3, x: -11, y: 3, width: 8, height: 8, color: 0x9999ff},
        {id: 4, x: 0, y: 3, width: 8, height: 8, color: 0xffff99},
        {id: 5, x: 11, y: 3, width: 8, height: 8, color: 0xff99ff},
    ];

    // ì•„ì´ì†Œë©”íŠ¸ë¦­ ë³€í™˜ í•¨ìˆ˜ (ì¤‘ì•™ ê¸°ì¤€ ì ìš©)
    const toIsometric = (x, y) => ({
        isoX: (x - y) + gridOffsetX,
        isoY: (x + y) / 2 + gridOffsetY,
    });

    function deg2rad(degrees) {
        return degrees * (Math.PI / 180);
    }

    // íˆ¬í‘œ ì˜ì—­ ê·¸ë¦¬ê¸°
    const drawVotingZones = () => {
        VOTING_ZONES.forEach(zone => {
            const topLeft = toIsometric(zone.x * cellSize, zone.y * cellSize);
            const topRight = toIsometric((zone.x + zone.width) * cellSize, zone.y * cellSize);
            const bottomLeft = toIsometric(zone.x * cellSize, (zone.y + zone.height) * cellSize);
            const bottomRight = toIsometric((zone.x + zone.width) * cellSize, (zone.y + zone.height) * cellSize);

            // íˆ¬í‘œ ì˜ì—­ ë‹¤ê°í˜• ìƒì„±
            const polygon = new PIXI.Graphics();
            polygon.beginFill(zone.color, 0.5);
            polygon.lineStyle(2, 0xffffff);
            polygon.moveTo(topLeft.isoX, topLeft.isoY);
            polygon.lineTo(topRight.isoX, topRight.isoY);
            polygon.lineTo(bottomRight.isoX, bottomRight.isoY);
            polygon.lineTo(bottomLeft.isoX, bottomLeft.isoY);
            polygon.lineTo(topLeft.isoX, topLeft.isoY);
            polygon.endFill();

            app.stage.addChild(polygon);

            // ì¤‘ì•™ í…ìŠ¤íŠ¸ ì¶”ê°€ (ì•„ì´ì†Œë©”íŠ¸ë¦­ ë³´ì •)
            const labelText = new PIXI.Text(`${zone.id} ë²ˆ`, {
                fontSize: 48,
                fill: 0xffffff,
            });
            labelText.anchor.set(0.5); // ì¤‘ì‹¬ì ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •

            // Xì¶•ë§Œ skew ì ìš© (ì•„ì´ì†Œë©”íŠ¸ë¦­ ê¸°ì¤€ 30ë„ ê¸°ìš¸ì„)
            const skewMatrix = new PIXI.Matrix();
            skewMatrix.set(1, 0.5, -2, 1); // Xì¶• skew ì ìš©
            labelText.transform.setFromMatrix(skewMatrix);

            // í…ìŠ¤íŠ¸ ì¤‘ì•™ ì¢Œí‘œë¥¼ ê³„ì‚°
            const centerX = (topLeft.isoX + bottomRight.isoX) / 2;
            const centerY = (topLeft.isoY + bottomRight.isoY) / 2;

            labelText.position.set(centerX, centerY); // ì¤‘ì•™ ì¢Œí‘œì— ë°°ì¹˜
            app.stage.addChild(labelText);
        });
    };

    const drawText = () => {
        const topLeft = toIsometric(0 * cellSize, 0 * cellSize);
        const bottomRight = toIsometric(0 * cellSize, 0 * cellSize);

        // ì¤‘ì•™ í…ìŠ¤íŠ¸ ì¶”ê°€ (ì•„ì´ì†Œë©”íŠ¸ë¦­ ë³´ì •)
        const labelText = new PIXI.Text(`2024 ë ˆëª¬ë² ì´ìŠ¤ ì†¡ë…„íšŒ`, {
            fontSize: 72,
            fill: 0xffffff,
        });
        labelText.anchor.set(0.5); // ì¤‘ì‹¬ì ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •

        // Xì¶•ë§Œ skew ì ìš© (ì•„ì´ì†Œë©”íŠ¸ë¦­ ê¸°ì¤€ 30ë„ ê¸°ìš¸ì„)
        const skewMatrix = new PIXI.Matrix();
        skewMatrix.set(1, 0.5, -2, 1); // Xì¶• skew ì ìš©
        labelText.transform.setFromMatrix(skewMatrix);

        // í…ìŠ¤íŠ¸ ì¤‘ì•™ ì¢Œí‘œë¥¼ ê³„ì‚°
        const centerX = (topLeft.isoX + bottomRight.isoX) / 2;
        const centerY = (topLeft.isoY + bottomRight.isoY) / 2;
        labelText.position.set(centerX, centerY); // ì¤‘ì•™ ì¢Œí‘œì— ë°°ì¹˜
        app.stage.addChild(labelText);
    }


    // ê·¸ë¦¬ë“œ ê·¸ë¦¬ê¸°
    const drawGrid = (size, gridWidth, gridHeight) => {
        const grid = new PIXI.Graphics();
        grid.lineStyle(1, 0xaaaaaa, 0.5);

        for (let x = -gridWidth; x <= gridWidth; x += size) {
            const start = toIsometric(x, -gridHeight);
            const end = toIsometric(x, gridHeight);
            grid.moveTo(start.isoX, start.isoY);
            grid.lineTo(end.isoX, end.isoY);
        }

        for (let y = -gridHeight; y <= gridHeight; y += size) {
            const start = toIsometric(-gridWidth, y);
            const end = toIsometric(gridWidth, y);
            grid.moveTo(start.isoX, start.isoY);
            grid.lineTo(end.isoX, end.isoY);
        }

        app.stage.addChild(grid);
    };

    // ì‚¬ìš©ì ì¶”ê°€
    const addUser = (id, x, y, color) => {
        if (users[id]) return;
        const {isoX, isoY} = toIsometric(x, y);

        // ê·¸ë¦¼ì ì¶”ê°€
        const shadow = new PIXI.Graphics();
        shadow.beginFill(0x000000, 0.5); // ê²€ì€ìƒ‰, ë°˜íˆ¬ëª…
        shadow.drawEllipse(0, 0, 30, 10); // íƒ€ì› ê·¸ë¦¼ì
        shadow.endFill();
        shadow.x = isoX;
        shadow.y = isoY + 10; // ê·¸ë¦¼ìë¥¼ ì•½ê°„ ì•„ë˜ë¡œ ì´ë™
        shadow.scale.set(1, 0.5); // ì•„ì´ì†Œë©”íŠ¸ë¦­ ëŠë‚Œìœ¼ë¡œ ì••ì¶•
        shadow.alpha = 0.4; // ê·¸ë¦¼ì íˆ¬ëª…ë„

        const circle = new PIXI.Graphics();
        circle.lineStyle(4, 0xffffff); // í…Œë‘ë¦¬ ë‘ê»˜ 4, ìƒ‰ìƒ í°ìƒ‰
        circle.beginFill(PIXI.utils.string2hex(color));
        circle.drawCircle(0, 0, 14);
        circle.endFill();

        circle.x = isoX;
        circle.y = isoY;

        const idText = new PIXI.Text(id.split('@')[0], {
            fontSize: 20,
            fill: 0xffffff,
            fontWeight: "bold",
        });
        idText.anchor.set(0.5, 1); // ì¤‘ì‹¬ì ì„ ì•„ë˜ìª½ìœ¼ë¡œ ì„¤ì •
        idText.x = isoX; // í…ìŠ¤íŠ¸ ì´ˆê¸° ìœ„ì¹˜
        idText.y = isoY - 20; // ì•„ì´ì½˜ ìœ„ì— í‘œì‹œ (20px ê°„ê²©)

        // ì´ëª¨ì§€ í…ìŠ¤íŠ¸ ì¶”ê°€
        const chatText = new PIXI.Text("", {
            fontSize: 48,
            fill: 0xffffff,
        });
        chatText.anchor.set(0.5);
        chatText.x = isoX;
        chatText.y = isoY - 36; // ì•„ì´ì½˜ ìœ„ì— ì´ëª¨ì§€ í‘œì‹œ

        // ì´ëª¨ì§€ í…ìŠ¤íŠ¸ ì¶”ê°€
        const scoreText = new PIXI.Text("", {
            fontSize: 48,
            fill: 0xffffff,
        });
        scoreText.anchor.set(0.5);
        scoreText.x = isoX;
        scoreText.y = isoY - 84; // ì•„ì´ì½˜ ìœ„ì— ì´ëª¨ì§€ í‘œì‹œ

        app.stage.addChild(shadow);
        app.stage.addChild(circle);
        app.stage.addChild(idText);
        app.stage.addChild(chatText);
        app.stage.addChild(scoreText);

        // ì‚¬ìš©ì ì €ì¥
        users[id] = {
            circle,
            idText,
            chatText,
            scoreText,
            shadow,
            x,
            y,
            targetX: x,
            targetY: y,
            currentX: x,
            currentY: y,
            color,
        };

        // ì‚¬ìš©ì ê°•ì¡° ìƒíƒœ ì¶”ê°€
        if (id === userId) {
            users[id].highlightState = {
                lineWidth: 4,
                growing: true, // í…Œë‘ë¦¬ê°€ êµµì–´ì§€ëŠ” ì¤‘ì¸ì§€ ì—¬ë¶€
            };
        }
    };

    // ì‚¬ìš©ì ê°•ì¡° ì—…ë°ì´íŠ¸
    const updateHighlight = () => {
        if (!userId || !users[userId]) return;

        const user = users[userId];
        const highlight = user.highlightState;

        if (highlight) {
            // í…Œë‘ë¦¬ ë‘ê»˜ ë³€ê²½
            if (highlight.growing) {
                highlight.lineWidth += 0.2; // í…Œë‘ë¦¬ ë‘ê»˜ ì¦ê°€ ì†ë„
                if (highlight.lineWidth >= 8) highlight.growing = false; // ìµœëŒ€ êµµê¸°
            } else {
                highlight.lineWidth -= 0.2; // í…Œë‘ë¦¬ ë‘ê»˜ ê°ì†Œ ì†ë„
                if (highlight.lineWidth <= 2) highlight.growing = true; // ìµœì†Œ êµµê¸°
            }

            // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            user.circle.clear();
            user.circle.lineStyle(highlight.lineWidth, 0xffffff); // í˜„ì¬ í…Œë‘ë¦¬ ë‘ê»˜ ì„¤ì •
            user.circle.beginFill(PIXI.utils.string2hex(user.color));
            user.circle.drawCircle(0, 0, 14);
            user.circle.endFill();
        }
    };

    // ì‚¬ìš©ì ì´ë™
    const moveUser = (id, x, y) => {
        if (!users[id]) return;

        const user = users[id];
        user.targetX = x;
        user.targetY = y;

        // ì´ˆê¸°í™” (ì²« ì´ë™ ì‹œ í˜„ì¬ ìœ„ì¹˜ ì„¤ì •)
        if (user.currentX === undefined || user.currentY === undefined) {
            user.currentX = x;
            user.currentY = y;
        }

        // í˜„ì¬ ì‚¬ìš©ì ì´ë™ ì‹œ ì¹´ë©”ë¼ ì´ë™
        // ì¹´ë©”ë¼ ëª©í‘œ ìœ„ì¹˜ë¥¼ ì—…ë°ì´íŠ¸
        if (id === userId) {
            const {isoX, isoY} = toIsometric(user.targetX, user.targetY);
            cameraPosition.targetX = -isoX * app.stage.scale.x + window.innerWidth / 2;
            cameraPosition.targetY = -isoY * app.stage.scale.y + window.innerHeight / 2;
        }

        updateUserZone(id);
    };

    // ë¶€ë“œëŸ½ê²Œ ì´ë™ì‹œí‚¤ê¸° ìœ„í•œ ë³´ê°„ë²• ì ìš©
    const updateUserPositions = () => {
        Object.values(users).forEach(user => {
            if (user.currentX === undefined || user.currentY === undefined) return;

            const INTERPOLATION_SPEED = 0.1; // ë³´ê°„ ì†ë„

            // ìœ„ì¹˜ ë³´ê°„ ì—…ë°ì´íŠ¸
            user.currentX += (user.targetX - user.currentX) * INTERPOLATION_SPEED;
            user.currentY += (user.targetY - user.currentY) * INTERPOLATION_SPEED;

            const {isoX, isoY} = toIsometric(user.currentX, user.currentY);
            user.circle.x = isoX;
            user.circle.y = isoY;

            user.shadow.x = isoX;
            user.shadow.y = isoY + 10; // ê·¸ë¦¼ìëŠ” ì•½ê°„ ì•„ë˜ì— ìœ„ì¹˜

            // ID í…ìŠ¤íŠ¸ ë° ì±„íŒ… í…ìŠ¤íŠ¸ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            user.idText.x = isoX;
            user.idText.y = isoY + 42; // ì•„ì´ì½˜ ìœ„ì— í‘œì‹œ

            user.chatText.x = isoX;
            user.chatText.y = isoY - 48; // ì•„ì´ì½˜ ìœ„ì— í‘œì‹œ

            user.scoreText.x = isoX;
            user.scoreText.y = isoY - 84; // ì•„ì´ì½˜ ìœ„ì— í‘œì‹œ
        });
    };


    // ìºë¦­í„° ì›€ì§ì„ ì—…ë°ì´íŠ¸
    const updateMovement = (delta) => {
        if (!userId || !users[userId]) return;

        let dx = 0, dy = 0;

        // ë°©í–¥í‚¤ ì…ë ¥ì— ë”°ë¥¸ ì´ë™ ê³„ì‚°
        if (keys.ArrowUp) dy -= baseSpeed * delta;
        if (keys.ArrowDown) dy += baseSpeed * delta;
        if (keys.ArrowLeft) dx -= baseSpeed * delta;
        if (keys.ArrowRight) dx += baseSpeed * delta;

        // ëŒ€ê°ì„  ì´ë™ ì¡°ì •
        if (dx !== 0 && dy !== 0) {
            dx *= Math.SQRT1_2; // 1 / âˆš2
            dy *= Math.SQRT1_2; // 1 / âˆš2
        }

        // ì´ë™ ì¤‘ì´ë©´ ì²˜ë¦¬
        if (dx !== 0 || dy !== 0) {
            const user = users[userId];

            // ì¶©ëŒ ê°ì§€
            const newX = user.x + dx;
            const newY = user.y + dy;
            if (!detectCollision(newX, newY)) { // ì¶©ëŒì´ ì—†ì„ ê²½ìš°ì—ë§Œ ì´ë™
                user.x = newX;
                user.y = newY;
                moveUser(userId, user.x, user.y);

                // ì„œë²„ë¡œ ìƒˆë¡œìš´ ìœ„ì¹˜ ì „ì†¡
                if (
                        Math.abs(user.x - lastSentPosition.x) > 5 || // ìµœì†Œ ì´ë™ ê±°ë¦¬ ê¸°ì¤€
                        Math.abs(user.y - lastSentPosition.y) > 5
                ) {
                    ws.send(JSON.stringify(
                            {type: "user_move", user_id: userId, x: user.x, y: user.y})
                    );
                    lastSentPosition = {x: user.x, y: user.y}; // ë§ˆì§€ë§‰ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                }
            }
        }
    };

    const detectCollision = (x, y) => {
        const collisionRadius = 15; // ì¶©ëŒ ë°˜ê²½ (ì‚¬ìš©ì ê°„ ìµœì†Œ ê±°ë¦¬)

        for (const [otherUserId, otherUser] of Object.entries(users)) {
            if (otherUserId === userId) continue; // ìì‹ ê³¼ ë¹„êµ ì œì™¸

            const dx = otherUser.currentX - x; // í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°
            const dy = otherUser.currentY - y; // í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < collisionRadius) {
                return true; // ì¶©ëŒ ë°œìƒ
            }
        }
        return false; // ì¶©ëŒ ì—†ìŒ
    };

    function isUserInZone(userX, userY, zone) {
        const zoneStartX = zone.x * cellSize;
        const zoneEndX = (zone.x + zone.width) * cellSize;
        const zoneStartY = zone.y * cellSize;
        const zoneEndY = (zone.y + zone.height) * cellSize;

        return userX >= zoneStartX && userX < zoneEndX && userY >= zoneStartY && userY < zoneEndY;
    }

    function getUserZone(userX, userY) {
        for (const zone of VOTING_ZONES) {
            if (isUserInZone(userX, userY, zone)) {
                return zone.id; // í•´ë‹¹ Zone ID ë°˜í™˜
            }
        }
        return null; // ì–´ëŠ Zoneì—ë„ ì†í•˜ì§€ ì•ŠìŒ
    }

    function updateUserZone(userId) {
        const user = users[userId];
        if (!user) return;

        const currentZone = getUserZone(user.x, user.y);

        // Voting Zone ë³€ê²½ ì²˜ë¦¬
        if (currentZone !== user.currentZone) {
            user.currentZone = currentZone; // í˜„ì¬ Zone ì—…ë°ì´íŠ¸
            if (currentZone) {
                // í•„ìš”ì‹œ WebSocketìœ¼ë¡œ ì„œë²„ì— Zone ì •ë³´ ì „ì†¡
                ws.send(JSON.stringify({
                    type: "zone_in",
                    user_id: userId,
                    zone_id: currentZone,
                }));
            } else {
                ws.send(JSON.stringify({
                    type: "zone_leave",
                    user_id: userId,
                }));
            }
        }
    }


    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘ í•¨ìˆ˜
    function startCountdown(seconds) {
        const countdownElement = document.getElementById("countdown");
        countdownElement.style.display = "block"; // ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ
        countdownElement.textContent = seconds; // ì´ˆê¸° ê°’ ì„¤ì •

        let remainingSeconds = seconds;

        const interval = setInterval(() => {
            remainingSeconds -= 1;
            countdownElement.textContent = remainingSeconds;

            if (remainingSeconds <= 0) {
                clearInterval(interval); // íƒ€ì´ë¨¸ ì¤‘ë‹¨
                countdownElement.style.display = "none"; // ì¹´ìš´íŠ¸ë‹¤ìš´ ìˆ¨ê¸°ê¸°

                // ì „ë‹¬
                ws.send(JSON.stringify({
                    'user_id': '{{user_id}}',
                    'type': 'count_down_end',
                }));

            }
        }, 1000); // 1ì´ˆë§ˆë‹¤ ì‹¤í–‰
    }

    // WebSocket ì—°ê²° new WebSocket("ws://localhost:8000/ws");
    // const ws = new WebSocket("wss://quagga-romantic-pug.ngrok-free.app/ws")
    const ws = new WebSocket("wss://spot-on.onrender.com/ws");
    ws.onopen = function () {
        ws.send(JSON.stringify({
            'user_id': '{{user_id}}',
            'type': 'login',
        }));
    }

    ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        switch (message.type) {
            case "init":
                userId = message.user_id; // í˜„ì¬ ì‚¬ìš©ì ID ì €ì¥
                lastSentPosition = {x: 0, y: 0}; // ì´ˆê¸°í™”

                message.users.forEach(user => addUser(user.user_id, user.x, user.y, user.color));
                // ì¹´ë©”ë¼ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì • (í˜„ì¬ ì‚¬ìš©ì ê¸°ì¤€)
                if (userId && users[userId]) {
                    const {x, y} = users[userId];
                    const {isoX, isoY} = toIsometric(x, y);
                    app.stage.position.set(
                            -isoX * app.stage.scale.x + window.innerWidth / 2,
                            -isoY * app.stage.scale.y + window.innerHeight / 2
                    );
                }
                break;
            case "user_join":
                addUser(message.user_id, message.x, message.y, message.color);
                break;
            case "user_move":
                moveUser(message.user_id, message.x, message.y);
                break;
            case "chat": // ì´ëª¨ì§€ í‘œì‹œ ì²˜ë¦¬
                if (users[message.user_id]) {
                    displayChat(message.user_id, message.chat);
                }
                break;
            case "count_down":
                const countDownValue = message.value;
                startCountdown(countDownValue);
                break;
            case "show_answer":
                message.user_ids.forEach(correct_user_id => {
                    displayScore(correct_user_id, message.chat);
                })
                break;
            case "result":
                const scoreResults = document.getElementById('score_results')
                scoreResults.innerHTML = '';
                message.results.forEach(result => {
                    const newDiv = document.createElement('div');
                    newDiv.textContent = result.user_id.split('@')[0] + ' : ' + result.score;
                    scoreResults.appendChild(newDiv);
                })
                scoreResults.style.display = scoreResults.style.display === "none" ? "" : "none";
                break;
            case "user_leave":
                if (users[message.user_id]) {
                    app.stage.removeChild(users[message.user_id].circle);
                    app.stage.removeChild(users[message.user_id].chatText);
                    app.stage.removeChild(users[message.user_id].idText);
                    delete users[message.user_id];
                }
                break;
        }
    };

    // ì´ëª¨ì§€ë¥¼ ë³´ë‚´ëŠ” í•¨ìˆ˜
    const sendEmoji = (emoji) => {
        if (!userId || !users[userId]) return;
        ws.send(JSON.stringify({type: "chat", user_id: userId, chat: emoji}));
    };

    const sendChat = () => {
        if (!userId || !users[userId]) return;
        const message = document.getElementById('chat-input').value;
        ws.send(JSON.stringify({type: "chat", user_id: userId, chat: message}));
        document.getElementById('chat-input').value = '';
    }


    let emojiTimeOutMap = {}
    // ì´ëª¨ì§€ë¥¼ ì‚¬ìš©ì ì•„ì´ì½˜ ìœ„ì— í‘œì‹œ
    const displayChat = (id, chat) => {
        if (!users[id]) return;

        const user = users[id];
        user.chatText.text = chat;
        clearInterval(emojiTimeOutMap[id]);

        // 2ì´ˆ í›„ ì´ëª¨ì§€ ì œê±°
        emojiTimeOutMap[id] = setTimeout(() => {
            user.chatText.text = "";
        }, 3000);
    };

    let scoreTimeoutMap = {};
    const displayScore = (id) => {
        if (!users[id]) return;

        const user = users[id];
        user.scoreText.text = '+10';
        clearInterval(scoreTimeoutMap[id]);

        // 2ì´ˆ í›„ ì´ëª¨ì§€ ì œê±°
        scoreTimeoutMap[id] = setTimeout(() => {
            user.scoreText.text = "";
        }, 3000);
    }

    // í‚¤ ë‹¤ìš´ ì´ë²¤íŠ¸
    window.addEventListener("keydown", (event) => {
        if (keys[event.key] !== undefined) keys[event.key] = true;
    });

    // í‚¤ ì—… ì´ë²¤íŠ¸
    window.addEventListener("keyup", (event) => {
        if (keys[event.key] !== undefined) {
            keys[event.key] = false;
        }
    });
    window.addEventListener("resize", () => {
        app.renderer.resize(window.innerWidth, window.innerHeight);
    });

    const activeKeys = new Set();

    // í‚¤ ì…ë ¥ ì¢…ë£Œ
    function stopKeyPress(key) {
        simulateKeyEvent(key, 'keyup'); // í‚¤ì—… ì´ë²¤íŠ¸ ë°œìƒ
        activeKeys.delete(key); // í™œì„±í™”ëœ í‚¤ ì œê±°
    }

    // ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¡œ ëˆ„ë¥´ê³  ìˆëŠ” ëª¨ë“  í‚¤ ë©ˆì¶¤ ì²˜ë¦¬
    function stopAllKeyPresses() {
        activeKeys.forEach(key => stopKeyPress(key));
    }

    // ì „ì—­ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('mouseup', stopAllKeyPresses);
    document.addEventListener('touchend', stopAllKeyPresses);

    const simulateKeyEvent = (key, type = "keydown") => {
        activeKeys.add(key)
        const event = new KeyboardEvent(type, {key});
        window.dispatchEvent(event);
    };

    // ê·¸ë¦¬ë“œì™€ ì•ˆë‚´ ë¬¸êµ¬ ê·¸ë¦¬ê¸°
    drawGrid(50, 10000, 10000);
    drawVotingZones();
    drawText();
    // Tickerë¡œ ìºë¦­í„° ì›€ì§ì„ ì—…ë°ì´íŠ¸
    app.ticker.add((delta) => {
        // ì¹´ë©”ë¼ ë³´ê°„ ì†ë„ ì„¤ì • (ê°’ì´ ì‘ì„ìˆ˜ë¡ ë” ë¶€ë“œëŸ¬ì›€)
        const CAMERA_LERP_SPEED = 0.1;
        if (cameraPosition.targetX !== undefined && cameraPosition.targetY !== undefined) {
            // ë³´ê°„ë²•ìœ¼ë¡œ ì¹´ë©”ë¼ ìœ„ì¹˜ë¥¼ ì—…ë°ì´íŠ¸
            cameraPosition.x += (cameraPosition.targetX - cameraPosition.x) * CAMERA_LERP_SPEED;
            cameraPosition.y += (cameraPosition.targetY - cameraPosition.y) * CAMERA_LERP_SPEED;
            app.stage.position.set(cameraPosition.x, cameraPosition.y);
        }

        updateHighlight();
        updateUserPositions(); // ë³´ê°„ ì—…ë°ì´íŠ¸
        updateMovement(delta);
    });
    app.stage.scale.set(zoomLevel);

</script>
</body>
</html>
